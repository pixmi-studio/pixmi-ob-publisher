name: Release Obsidian Plugin

on:
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Handle Versioning
        id: versioning
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version in package.json: $CURRENT_VERSION"
          
          # Check if tag exists remotely
          if git ls-remote --exit-code --tags origin "v$CURRENT_VERSION" >/dev/null 2>&1; then
            echo "Tag v$CURRENT_VERSION exists. Bumping patch version..."
            npm version patch -m "chore(release): bump version to %s [skip ci]"
            
            NEW_VERSION=$(node -p "require('./package.json').version")
            echo "New version: $NEW_VERSION"
            echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
            
            # Push the commit and the new tag
            git push origin master
            git push origin "v$NEW_VERSION"
          else
            echo "Tag v$CURRENT_VERSION does not exist. Using current version."
            echo "VERSION=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            
            # Create and push tag for current version
            git tag -a "v$CURRENT_VERSION" -m "Release v$CURRENT_VERSION"
            git push origin "v$CURRENT_VERSION"
          fi

      - name: Install Dependencies
        run: npm install

      - name: Build Plugin
        run: npm run build

      - name: Package Plugin
        run: |
          mkdir pixmi-ob-publisher
          cp dist/main.js pixmi-ob-publisher/main.js
          cp manifest.json pixmi-ob-publisher/manifest.json
          zip -r pixmi-ob-publisher.zip pixmi-ob-publisher

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.versioning.outputs.VERSION }}
          name: Release v${{ steps.versioning.outputs.VERSION }}
          draft: false
          prerelease: false
          files: pixmi-ob-publisher.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
